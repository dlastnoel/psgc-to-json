<?php

namespace App\Actions\Psgc;

use App\Models\Barangay;
use App\Models\CityMunicipality;
use App\Models\PsgcVersion;
use App\Models\Province;
use App\Models\Region;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use PhpOffice\PhpSpreadsheet\IOFactory;

class ImportPsgcData
{
    protected string $filePath;

    protected array $regions = [];

    protected array $provinces = [];

    protected array $citiesMunicipalities = [];

    protected array $barangays = [];

    protected int $regionsCount = 0;

    protected int $provincesCount = 0;

    protected int $citiesMunicipalitiesCount = 0;

    protected int $barangaysCount = 0;

    protected ?PsgcVersion $psgcVersion = null;

    protected ?string $filename = null;

    protected ?string $downloadUrl = null;

    protected ?string $quarter = null;

    protected ?string $year = null;

    public function __construct(string $filePath, ?string $filename = null, ?string $downloadUrl = null)
    {
        $this->filePath = $filePath;
        $this->filename = $filename;
        $this->downloadUrl = $downloadUrl;
    }

    public static function run(string $filePath, ?string $filename = null, ?string $downloadUrl = null): array
    {
        $importer = new self($filePath, $filename, $downloadUrl);

        return $importer->execute();
    }

    public function execute(): array
    {
        $spreadsheet = IOFactory::load($this->filePath);
        $sheet = $spreadsheet->getSheetByName(config('psgc.validation.required_sheet'));

        if (! $sheet) {
            return [
                'success' => false,
                'message' => 'PSGC sheet not found',
            ];
        }

        $this->parseSheet($sheet);
        $this->extractVersionInfo();
        $this->createPsgcVersion();
        $this->establishRelationships();
        $this->saveData();
        $this->updatePsgcVersionCounts();
        $this->markVersionAsCurrent();

        return [
            'success' => true,
            'psgc_version_id' => $this->psgcVersion->id,
            'quarter' => $this->quarter,
            'year' => $this->year,
            'regions' => $this->regionsCount,
            'provinces' => $this->provincesCount,
            'cities_municipalities' => $this->citiesMunicipalitiesCount,
            'barangays' => $this->barangaysCount,
        ];
    }

    protected function parseSheet($sheet): void
    {
        $headers = [];
        $headerRowFound = false;

        foreach ($sheet->getRowIterator() as $rowIndex => $row) {
            $rowData = [];

            foreach ($row->getCellIterator() as $cell) {
                $rowData[] = (string) $cell->getValue();
            }

            if (! $headerRowFound) {
                $headers = $rowData;
                $headerRowFound = true;

                continue;
            }

            $this->processRow($headers, $rowData);
        }
    }

    protected function processRow(array $headers, array $rowData): void
    {
        $data = array_combine($headers, $rowData);

        $code = $data['10-digit PSGC'] ?? '';
        $name = $data['Name'] ?? '';
        $oldName = $data['Old Name'] ?? '';
        $correspondenceCode = $data['Correspondence Code'] ?? '';
        $geographicLevel = trim($data['Geographic Level'] ?? '');
        $status = $data['Status'] ?? '';

        if (empty($code) || empty($name) || empty($geographicLevel)) {
            return;
        }

        $normalizedLevel = strtolower($geographicLevel);

        // Map abbreviations to full level names
        $levelMap = [
            'reg' => 'Region',
            'prov' => 'Province',
            'city' => 'City',
            'mun' => 'Municipality',
            'bgy' => 'Barangay',
            'submun' => 'SubMun',
        ];

        $mappedLevel = $levelMap[$normalizedLevel] ?? $geographicLevel;

        // Extract region prefix (first 2 digits)
        $regionPrefix = substr($code, 0, 2);

        // Check if this is NCR (Region 13)
        $isNCR = $regionPrefix === '13';

        // Detect capital status from 'Status' column
        $isCapital = stripos(trim($status), 'Capital') !== false;

        if ($normalizedLevel === 'reg' || $normalizedLevel === 'region') {
            $this->regions[$code] = [
                'code' => $code,
                'name' => $name,
                'old_name' => $oldName,
                'correspondence_code' => $correspondenceCode,
                'geographic_level' => $mappedLevel,
            ];
        } elseif ($normalizedLevel === 'prov' || $normalizedLevel === 'province') {
            $this->provinces[$code] = [
                'code' => $code,
                'name' => $name,
                'old_name' => $oldName,
                'correspondence_code' => $correspondenceCode,
                'geographic_level' => $mappedLevel,
                'is_capital' => $isCapital,
                'is_elevated_city' => false,
            ];
        } elseif ($normalizedLevel === 'city') {
            // ELEVATE NCR cities to provinces table
            if ($isNCR) {
                $this->provinces[$code] = [
                    'code' => $code,
                    'name' => $name,
                    'old_name' => $oldName,
                    'correspondence_code' => $correspondenceCode,
                    'geographic_level' => $mappedLevel,
                    'is_capital' => $isCapital,
                    'is_elevated_city' => true, // Flag this as elevated
                ];
            } else {
                // Non-NCR cities go to cities_municipalities table
                $this->citiesMunicipalities[$code] = [
                    'code' => $code,
                    'name' => $name,
                    'old_name' => $oldName,
                    'correspondence_code' => $correspondenceCode,
                    'geographic_level' => $mappedLevel,
                    'is_capital' => $isCapital,
                ];
            }
        } elseif (in_array($normalizedLevel, ['mun', 'municipality', 'submun'], true)) {
            // All municipalities and SubMun go to cities_municipalities table (not elevated to provinces)
            $this->citiesMunicipalities[$code] = [
                'code' => $code,
                'name' => $name,
                'old_name' => $oldName,
                'correspondence_code' => $correspondenceCode,
                'geographic_level' => $mappedLevel,
                'is_capital' => $isCapital,
            ];
        } elseif ($normalizedLevel === 'bgy' || $normalizedLevel === 'barangay') {
            $this->barangays[$code] = [
                'code' => $code,
                'name' => $name,
                'old_name' => $oldName,
                'correspondence_code' => $correspondenceCode,
                'geographic_level' => $mappedLevel,
            ];
        }
    }

    protected function establishRelationships(): void
    {
        // Establish province -> region relationships
        foreach ($this->provinces as $code => &$province) {
            $regionPrefix = substr($code, 0, 2); // First 2 digits = region
            $regionCode = $regionPrefix . '00000000'; // Match 10-digit region code

            if (isset($this->regions[$regionCode]) && isset($this->regions[$regionCode]['id'])) {
                $province['region_id'] = $this->regions[$regionCode]['id'];
            }
        }

        // Establish city -> region relationships
        foreach ($this->citiesMunicipalities as $code => &$cityMunicipality) {
            $regionPrefix = substr($code, 0, 2); // First 2 digits = region
            $regionCode = $regionPrefix . '00000000'; // Match 10-digit region code

            if (isset($this->regions[$regionCode]) && isset($this->regions[$regionCode]['id'])) {
                $cityMunicipality['region_id'] = $this->regions[$regionCode]['id'];
            }
        }
    }

    protected function establishBarangayRelationships(): void
    {
        // Establish barangay relationships (only run after cities are saved so they have IDs)
        foreach ($this->barangays as $code => &$barangay) {
            $regionPrefix = substr($code, 0, 2); // First 2 digits = region
            $provincePrefix = substr($code, 0, 6); // First 6 digits = province
            $cityPrefix = substr($code, 0, 8); // First 8 digits = city/municipality

            $regionCode = $regionPrefix . '00000000'; // Match 10-digit region code
            $provinceCode = $provincePrefix . '0000'; // Match 10-digit province code
            $cityCode = $cityPrefix . '00'; // Match 10-digit city/municipality code

            if (isset($this->regions[$regionCode])) {
                $barangay['region_id'] = $this->regions[$regionCode]['id'] ?? null;
            }

            if (isset($this->provinces[$provinceCode])) {
                $barangay['province_id'] = $this->provinces[$provinceCode]['id'] ?? null;
            }

            // Set city_municipality_id based on parent type:
            // 1. If parent is in cities_municipalities table (municipality, SubMun)
            // 2. If parent is an elevated NCR city (in provinces table)
            if (isset($this->citiesMunicipalities[$cityCode])) {
                // Parent is a regular municipality/SubMun
                $barangay['city_municipality_id'] = $this->citiesMunicipalities[$cityCode]['id'] ?? null;
            } elseif (isset($this->provinces[$cityCode])) {
                // Parent is an elevated NCR city (in provinces table)
                $barangay['city_municipality_id'] = $this->provinces[$cityCode]['id'] ?? null;
            }
        }
    }

    protected function saveData(): void
    {
        DB::transaction(function () {
            $this->saveRegions();
            $this->establishRelationships();
            $this->saveProvinces();
            $this->saveCitiesMunicipalities();
            $this->establishBarangayRelationships();
            $this->saveBarangays();
        });
    }

    protected function saveRegions(): void
    {
        foreach ($this->regions as $code => &$region) {
            $region['psgc_version_id'] = $this->psgcVersion->id;
            $created = Region::updateOrCreate(
                ['code' => $code, 'psgc_version_id' => $this->psgcVersion->id],
                [
                    'name' => $region['name'],
                    'old_name' => $region['old_name'] ?? null,
                    'correspondence_code' => $region['correspondence_code'],
                    'geographic_level' => $region['geographic_level'],
                    'psgc_version_id' => $this->psgcVersion->id,
                ]
            );

            $region['id'] = $created->id;

            if ($created->wasRecentlyCreated) {
                $this->regionsCount++;
            }
        }
    }

    protected function saveProvinces(): void
    {
        foreach ($this->provinces as $code => &$province) {
            $province['psgc_version_id'] = $this->psgcVersion->id;

            // Get region code from province code (first 2 digits + '00000000')
            $regionCode = substr($code, 0, 2) . '00000000';

            $created = Province::updateOrCreate(
                ['code' => $code, 'psgc_version_id' => $this->psgcVersion->id],
                [
                    'name' => $province['name'],
                    'old_name' => $province['old_name'] ?? null,
                    'correspondence_code' => $province['correspondence_code'],
                    'geographic_level' => $province['geographic_level'],
                    'is_capital' => $province['is_capital'] ?? false,
                    'is_elevated_city' => $province['is_elevated_city'] ?? false,
                    'region_id' => $province['region_id'] ?? null,
                    'region_code' => $regionCode, // Add region code for reference
                    'province_code' => $code, // Add province code for reference (same as code column)
                    'psgc_version_id' => $this->psgcVersion->id,
                ]
            );

            $province['id'] = $created->id;

            if ($created->wasRecentlyCreated) {
                $this->provincesCount++;
            }
        }
    }

    protected function saveCitiesMunicipalities(): void
    {
        foreach ($this->citiesMunicipalities as $code => &$cityMunicipality) {
            $cityMunicipality['psgc_version_id'] = $this->psgcVersion->id;

            // Determine province_id based on location:
            // 1. Non-NCR cities: Use traditional province (first 4 digits + '000000')
            // 2. NCR municipalities/SubMun: Use elevated city's ID if matches
            $isNCR = substr($code, 0, 2) === '13'; // NCR region code
            $provinceId = null;

            if ($isNCR) {
                // For NCR, find matching elevated city and use its ID as province_id
                $prefix = substr($code, 0, 4); // First 4 digits (city/municipality prefix)

                // Try to find an elevated city with matching prefix
                foreach ($this->provinces as $provCode => $province) {
                    if (substr($provCode, 0, 4) === $prefix && ($province['is_elevated_city'] ?? false)) {
                        $provinceId = $province['id'];
                        break;
                    }
                }
            } else {
                // For Non-NCR, use traditional province
                $provincePrefix = substr($code, 0, 4);
                $provinceCode = $provincePrefix . '000000';

                if (isset($this->provinces[$provinceCode])) {
                    $provinceId = $this->provinces[$provinceCode]['id'];
                }
            }

            // Get region code from city code (first 2 digits + '00000000')
            $regionCode = substr($code, 0, 2) . '00000000';

            // Get province code for reference
            $provinceCodeRef = null;
            if ($provinceId) {
                // Find the province code by its ID
                foreach ($this->provinces as $provCode => $prov) {
                    if ($prov['id'] === $provinceId) {
                        $provinceCodeRef = $provCode;
                        break;
                    }
                }
            }

            $data = [
                'name' => $cityMunicipality['name'],
                'old_name' => $cityMunicipality['old_name'] ?? null,
                'correspondence_code' => $cityMunicipality['correspondence_code'],
                'geographic_level' => $cityMunicipality['geographic_level'],
                'region_id' => $cityMunicipality['region_id'] ?? null,
                'region_code' => $regionCode, // Add region code for reference
                'province_id' => $provinceId,
                'province_code' => $provinceCodeRef, // Add province code for reference
                'is_capital' => $cityMunicipality['is_capital'] ?? false,
                'psgc_version_id' => $this->psgcVersion->id,
            ];

            $created = CityMunicipality::updateOrCreate(
                ['code' => $code, 'psgc_version_id' => $this->psgcVersion->id],
                $data
            );

            $cityMunicipality['id'] = $created->id;

            if ($created->wasRecentlyCreated) {
                $this->citiesMunicipalitiesCount++;
            }
        }
    }

    protected function saveBarangays(): void
    {
        foreach ($this->barangays as $code => $barangay) {
            $barangay['psgc_version_id'] = $this->psgcVersion->id;
            $data = [
                'code' => $code,
                'name' => $barangay['name'],
                'old_name' => $barangay['old_name'] ?? null,
                'correspondence_code' => $barangay['correspondence_code'],
                'geographic_level' => $barangay['geographic_level'],
                'psgc_version_id' => $this->psgcVersion->id,
            ];

            if (isset($barangay['region_id'])) {
                $data['region_id'] = $barangay['region_id'];
            }

            if (isset($barangay['province_id'])) {
                $data['province_id'] = $barangay['province_id'];
            }

            if (isset($barangay['city_municipality_id'])) {
                $data['city_municipality_id'] = $barangay['city_municipality_id'];
            }

            $created = Barangay::updateOrCreate(
                ['code' => $code, 'psgc_version_id' => $this->psgcVersion->id],
                $data
            );

            if ($created->wasRecentlyCreated) {
                $this->barangaysCount++;
            }
        }
    }

    /**
     * Extract version information from filename.
     */
    protected function extractVersionInfo(): void
    {
        if ($this->filename === null) {
            return;
        }

        $pattern = config('psgc.filename_pattern');

        if (preg_match($pattern, basename($this->filename), $matches)) {
            $this->quarter = $matches[1];
            $this->year = $matches[2];
        }
    }

    /**
     * Create new PsgcVersion record.
     */
    protected function createPsgcVersion(): void
    {
        $this->psgcVersion = new PsgcVersion([
            'quarter' => $this->quarter ?? null,
            'year' => $this->year ?? null,
            'publication_date' => now(),
            'download_url' => $this->downloadUrl,
            'filename' => $this->filename,
            'is_current' => false,
        ]);

        $this->psgcVersion->save();
    }

    /**
     * Update PsgcVersion with record counts.
     */
    protected function updatePsgcVersionCounts(): void
    {
        $this->psgcVersion->update([
            'regions_count' => $this->regionsCount,
            'provinces_count' => $this->provincesCount,
            'cities_municipalities_count' => $this->citiesMunicipalitiesCount,
            'barangays_count' => $this->barangaysCount,
        ]);
    }

    /**
     * Mark this version as current.
     */
    protected function markVersionAsCurrent(): void
    {
        $this->psgcVersion->setCurrent();
    }
}
